%----------------------------------------------------------------------------------------
%	PACKETS AND CONFIGURATION
%----------------------------------------------------------------------------------------

\documentclass[12pt, a4paper]{article}

\usepackage{times} % Times New Roman font
\usepackage{graphicx} % 'graphics' package interface
\usepackage{geometry} % Edit document margins
\usepackage{hyperref} % Table of contents hyperlinks
\usepackage{tcolorbox} % Colored boxes for code
\usepackage[font=small, labelfont=bf]{caption} % Image caption font
\usepackage{longtable} % Build long tables
\usepackage{xurl} % URL breaking
\usepackage{float} % URL breaking

% HELPER PACKAGES (REMOVE IN FINAL) %
\usepackage{blindtext} % Lorem Ipsum
\usepackage{todonotes} % TODOs as useful reminders
\setlength{\marginparwidth}{2cm} % Otherwise todonotes gets angry at me lol
\setuptodonotes{fancyline, color=green!40, shadow} % TODOs options
% HELPER PACKAGES (REMOVE IN FINAL) %

\graphicspath{ {./res/} } % Path to graphics
\hypersetup{    % ToC Hyperlink setup
    colorlinks,
    citecolor=blue,
    filecolor=blue,
    linkcolor=blue,
    urlcolor=blue
}

% Add subsubsubsection

\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}

%----------------------------------------------------------------------------------------
%	DOCUMENT
%----------------------------------------------------------------------------------------

\begin{document}

\newgeometry{top=7cm, bottom=2cm} % Setting the margins for the title

% Title
\begin{titlepage}
  \centering
  {\Huge\bfseries Pandemic Information System Model\par} % Project title
  \vspace{1.5cm}
  {\scshape\large Systems and Methods for Big and Unstructured Data \par} % Course
  \vspace{0.5cm}
  {\scshape\large Prof. Marco Brambilla \par} % Professor
  \vspace{1cm}
  {\scshape\large % Description
      Third delivery \par 
      Elasticsearch Project \par 
  }
  \vspace{0.5cm}
  {\slshape\large January 2022 \par} % Date
  \vspace{1cm}
  \linespread{0.8} % Authors interline
  {\large\itshape % Authors
      Avci Oguzhan - \texttt{10557284}\\
      Gentile Nicole - \texttt{10594355}\\
      Rigamonti Davide - \texttt{10629791}\\
      Singh Raul - \texttt{10623232}\\
      Tagliaferri Mattia - \texttt{10572418}
  }
  \vfill
  \begin{figure}[b]
      \includegraphics[scale=0.6]{polimi.png} % Polimi logo
      \centering
  \end{figure}

  \pagenumbering{gobble} % Remove page number
\end{titlepage}

\newgeometry{bottom=3cm} % Reset the margins
\pagenumbering{arabic} % Reset the page number

\clearpage

% INDEX
{
    \hypersetup{hidelinks}
    \tableofcontents
}

% LIST OF TODOs (REMOVE IN FINAL)
\listoftodos

\clearpage

% Paragraph skip
\setlength{\parskip}{\baselineskip}%
\setlength{\parindent}{0pt}%

% INTRODUCTION
\section{Introduction}

\subsection{Problem Specification}

The idea of the project is to use Elasticsearch to store and analyze data about 
COVID-19 vaccinations in Italy. The data we used can be found in the following 
GitHub repository: \url{https://raw.githubusercontent.com/italia/covid19-opendata-vaccini/master/dati/somministrazioni-vaccini-latest.csv}
and contains data about daily vaccinations divided by region, age range and vaccine
supplier. \\ 
The main goal is to analyze the data in order to build meaningful statistics 
about the vaccinations in Italy; examples can be the total number of doses for each 
vaccine brand, the top regions for vaccine administration and so on.

\subsection{Hypoteses}

\begin{itemize}
  \item[] We assumed that the general user doesn't know the italian language, therefore
    all the fields' names contained in the dataset were renamed to an appropriate 
    english translation. 
  \item[] For the file dpc-covid19-ita-regioni.csv we decided to not include some fields
    mainly because they are no longer updated or they are not entirely relevant for the
    scope of this project.
\end{itemize}
  
\clearpage

% DATABASE
\section{Data }

\subsection{Schema description}

\begin{itemize}
  \item Schema for \textbf{vaccines administrations} 
    (somministrazioni-vaccini-latest.csv):
    \begin{itemize}
      \item @timestamp: \emph{date} \\
        \begin{footnotesize}
          Timestamp assigned by elasticsearch.
        \end{footnotesize}
      \item administration\_date (data\_somministrazione): \emph{date [iso8601]} \\
        \begin{footnotesize}
          Date of all the doses' administrations using the international standard format.
        \end{footnotesize}
      \item supplier (fornitore): \emph{keyword} \\
        \begin{footnotesize}
          Brand of the administrated vaccine, mapped as keyword since entries are 
          enumerated and aggregation is possible.
        \end{footnotesize}
      \item area (area): \emph{keyword} \\
        \begin{footnotesize}
          Abbreviation for a region's name, mapped as keyword since entries are 
          enumerated and aggregation is possible.
        \end{footnotesize}
      \item age\_range (fascia\_anagrafica): \emph{keyword} \\
        \begin{footnotesize}
          Age range of the people administered with the vaccines, mapped as keyword since
          entries are enumerated and aggregation is possible.
        \end{footnotesize}
      \item male\_gender (sesso\_maschile): \emph{long} \\
        \begin{footnotesize}
          Total number of vaccinations administered to males by day and region, mapped as
          a long since it represents a possibly large number.
        \end{footnotesize}
      \item female\_gender (sesso\_femminile): \emph{long} \\
        \begin{footnotesize}
          Total number of vaccinations administered to females by day and region, mapped
          as a long since it represents a possibly large number.
        \end{footnotesize}
      \item first\_dose (prima\_dose): \emph{long} \\
        \begin{footnotesize}
          Total number of administered first doses, mapped as a long since it represents
          a possibly large number.
        \end{footnotesize}
      \item second\_dose (seconda\_dose): \emph{long} \\
        \begin{footnotesize}
          Total number of administered second doses, mapped as a long since it represents
          a possibly large number.
        \end{footnotesize}
      \item previous\_infection (pregressa\_infezione): \emph{long} \\
        \begin{footnotesize}
          Total number of administered doses to subjects with a previous Covid-19 
          infection within 3 to 6 months before the \it{administration date}, therefore 
          needing only one dose, mapped as a long since it represents a possibly large 
          number. 
        \end{footnotesize}
      \item booster\_dose (dose\_addizionale\_booster): \emph{long} \\
        \begin{footnotesize}
          Total number of administered booster doses, mapped as a long since it 
          represents a possibly large number.
        \end{footnotesize}
      \item total\_doses: \emph{long} \\
        \begin{footnotesize}
          Total number of administered doses considering first, second, booster and previous 
          infection doses, mapped as a long since it represents a possibly large number.
        \end{footnotesize}
      \item NUTS1\_code (codice\_NUTS1): \emph{keyword} \\
        \begin{footnotesize}
          European classifications for territorial units (Level: NUTS 1), mapped as 
          keyword since entries are enumerated and aggregation is possible.
        \end{footnotesize}
      \item NUTS2\_code (codice\_NUTS2): \emph{keyword} \\
        \begin{footnotesize}
          European classifications for territorial units (Level: NUTS 2), mapped as 
          keyword since entries are enumerated and aggregation is possible.
        \end{footnotesize}
      \item ISTAT\_region\_code (codice\_regione\_ISTAT): \emph{keyword} \\
        \begin{footnotesize}
          ISTAT code used for identifying regions, mapped as keyword since entries are 
          enumerated and aggregation is possible. Additionally, in order to fully utilize
          the map representation capabilities of Kibana this value needs to be joined 
          with Kibana's own ISTAT regional codes (stored as keywords), besides, it would 
          be useless to execute arithmetical operations on this value due to its nature.
        \end{footnotesize}
      \item area\_name (nome\_area): \emph{text} \\
        \begin{footnotesize}
          Full name of the region mapped as text in order to be better suited for queries
          that utilize an analyzer. Even though this field technically represents an 
          enumeration, we found particulary useful the ability to search for a region's 
          name utilizing a text analyzer since there are plenty other fields that can be 
          used to aggregate regions.
        \end{footnotesize}
    \end{itemize}
  \item Schema for \textbf{population} (platea.csv):
    \begin{itemize}
      \item area (area): \emph{keyword} \\
        \begin{footnotesize}
          Abbreviation for a region's name, mapped as keyword since entries are 
          enumerated and aggregation is possible.
        \end{footnotesize}
      \item area\_name (nome\_area): \emph{text} \\
        \begin{footnotesize}
          Full name of the region mapped as text in order to be better suited for queries
          that utilize an analyzer.
        \end{footnotesize}
      \item age\_range (fascia\_anagrafica): \emph{keyword} \\
        \begin{footnotesize}
          Age range of the people administered with the vaccines, mapped as keyword since
          entries are enumerated and aggregation is possible.
        \end{footnotesize}
      \item total\_population (totale\_popolazione): \emph{long} \\
        \begin{footnotesize}
          Total population for an associated area and age range, mapped as a long since 
          it represents a large number.
        \end{footnotesize}
    \end{itemize}
  \item Schema for \textbf{healed} (soggetti-guariti.csv):
    \begin{itemize}
      \item area (area): \emph{keyword} \\
        \begin{footnotesize}
          Abbreviation for a region's name, mapped as keyword since entries are 
          enumerated and aggregation is possible.
        \end{footnotesize}
      \item area\_name (nome\_area): \emph{text} \\
        \begin{footnotesize}
          Full name of the region mapped as text in order to be better suited for queries
          that utilize an analyzer.
        \end{footnotesize}
      \item age\_range (fascia\_anagrafica): \emph{keyword} \\
        \begin{footnotesize}
          Age range of the people administered with the vaccines, mapped as keyword since
          entries are enumerated and aggregation is possible.
        \end{footnotesize}
      \item total\_healed (totale\_healed): \emph{long} \\
        \begin{footnotesize}
          Total number of people that heald from an infection in a 6 months timespan for
          an associated area and age range, mapped as a long since it represents a large 
          number.      
        \end{footnotesize}
    \end{itemize}
  \item Schema for \textbf{covid-information} (dpc-covid19-ita-regioni.csv):
    \begin{itemize}
      \item @timestamp: \emph{date} \\
        \begin{footnotesize}
          Timestamp assigned by elasticsearch.
        \end{footnotesize}
      \item date: \emph{date [iso8601]} \\
        \begin{footnotesize}
          Date of the government information.
        \end{footnotesize}
      \item area\_name (denominazione\_regione): \emph{text} \\
        \begin{footnotesize}
          Full name of the region mapped as text in order to be better suited for queries
          that utilize an analyzer.
        \end{footnotesize}
      \item ISTAT\_region\_code: \emph{keyword} \\
        \begin{footnotesize}
          ISTAT code used for identifying regions, mapped as keyword since entries are 
          enumerated and aggregation is possible.
        \end{footnotesize}
      \item deceased: \emph{long} \\
        \begin{footnotesize}
          Total number of people that are deceased due to Covid-19, mapped as a long 
          since it represents a large number.
        \end{footnotesize}
      \item recovered: \emph{long} \\
        \begin{footnotesize}
          Total number of people that have been dismissed from the hospital because they
          have recovered from Covid-19, mapped as a long since it represents a large 
          number.
        \end{footnotesize}
      \item home\_confinement: \emph{long} \\
        \begin{footnotesize}
          Total number of people that are home confined due to Covid-19, mapped as a long
          since it represents a large number.
        \end{footnotesize}
      \item lat: \emph{double} \\
        \begin{footnotesize}
          Latitude of the region, mapped as a double since it's a float number.
        \end{footnotesize}
      \item long: \emph{double} \\
        \begin{footnotesize}
          Longitude of the region, mapped as a double since it's a float number.
        \end{footnotesize}
      \item notes: \emph{text} \\
        \begin{footnotesize}
          General notes from the government, mapped as text in order to be better 
          suited for queries that utilize an analyzer.
        \end{footnotesize}
      \item cases\_notes: \emph{text} \\
        \begin{footnotesize}
          Notes related to the tested cases from the government, mapped as text in order
          to be better suited for queries that utilize an analyzer.
        \end{footnotesize}
      \item new\_positives: \emph{long} \\
        \begin{footnotesize}
          Daily new number of people that have been tested positive due to Covid-19, 
          mapped as a long since it represents a large number.
        \end{footnotesize}
      \item hospitalized\_with\_symptoms: \emph{long} \\
        \begin{footnotesize}
          Total number of people that have been hospitalized with symptoms of Covid-19,
          mapped as a long since it represents a large number.
        \end{footnotesize}
      \item country: \emph{keyword} \\
        \begin{footnotesize}
          Code indicating the country, mapped as keyword since entries are 
          enumerated and aggregation is possible.
        \end{footnotesize}
      \item tests: \emph{long} \\
        \begin{footnotesize}
          Total number of people that have been tested for Covid-19 (using molecular 
          tests), mapped as a long since it represents a large number.
        \end{footnotesize}
      \item intensive\_care: \emph{long} \\
        \begin{footnotesize}
          Total number of people that are in intensive care due to Covid-19, mapped as 
          a long since it represents a large number.
        \end{footnotesize}
      \item total\_cases: \emph{long} \\
        \begin{footnotesize}
          Total amount of positive cases, mapped as a long since it represents a large 
          number.
        \end{footnotesize}
      \item total\_hospitalized: \emph{long} \\
        \begin{footnotesize}
          Total number of people that have been hospitalized due to Covid-19, mapped as 
          a long since it represents a large number.
        \end{footnotesize}
      \item total\_positives: \emph{long} \\
        \begin{footnotesize}
          Total number of people that have been found positive to Covid-19 (either via 
          test or home confinement), mapped as a long since it represents a large number.
        \end{footnotesize} 
      \item total\_positives\_variation: \emph{long} \\
        \begin{footnotesize}
          Daily variation of the total number of people that have been tested positive 
          to Covid-19, mapped as a long since it represents a large number.
        \end{footnotesize}
      \item location: \emph{geo\_point} \\
        \begin{footnotesize}
          The combination of the latitude and longitude fields, mapped as geo\_point 
          since they represent a set of coordinates.
        \end{footnotesize}    
    \end{itemize}
\end{itemize}

\subsection{Dataset description}

The dataset contains data about COVID-19 vaccinations in Italy. \\
For each day, region, age range and vaccine supplier we have information about: the 
number of vaccinated people (male and female), the number of 1st, 2nd and booster doses
and information about the number of people who was previously infected. \\
We decided to integrate this data using the ‘platea.csv’ dataset that can be found 
in the specified repository; it contains data about the population for each region 
and each age range. \\ 
We also used information about the number of healed people in each region that can be 
found in ‘soggetti-guariti.csv’ present in the same repository. \\
In addition, we used the ‘dpc-covid19-ita-regioni.csv’ dataset to have more information 
about the pandemic, from the total number of positives to the number of hospitalized 
and deceased people.

%QUERIES
\subsection{Queries}

\subsubsection{Number of daily vaccines for each dose}
Total number of first, second and booster doses administred in each date.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{
"size": 0, 
  "aggs": {
    "Administration Date": {
      "terms": {
        "field": "administration_date",
        "size": 370
      },
      "aggs": {
        "totalFirstDoses": {
          "sum": {
            "field": "first_dose"
          }
        },        
        "totalSecondDoses": {
          "sum": {
            "field": "second_dose"
          }
        },        
        "totalBoosters": {
          "sum": {
            "field": "booster_dose"
          }
        }
      }
    }
  } 
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of doses per gender in each region}
Total doses administred to men and to women in each region. 
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{
"size": 0, 
  "aggs": {
    "Region": {
      "terms": {
        "field": "area",
        "size": 21
      },
      "aggs": {
        "totalWomenDoses": {
          "sum": {
            "field": "female_gender"
          }
        },        
        "totalMenDoses": {
          "sum": {
            "field": "male_gender"
          }
        }
      }
    }
  } 
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of vaccines per dose number in each region}
Total number of first, second, booster and total doses administred in each region.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{
"size": 0, 
  "aggs": {
    "Region": {
      "terms": {
        "field": "area",
        "size": 21
      },
      "aggs": {
        "totalFirstDoses": {
          "sum": {
            "field": "first_dose"
          }
        },        
        "totalSecondDoses": {
          "sum": {
            "field": "second_dose"
          }
        },        
        "totalBoosters": {
          "sum": {
            "field": "booster_dose"
          }
        },        
        "totalDoses": {
          "sum": {
            "field": "total_doses"
          }
        }
      }
    }
  } 
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of doses for each vaccine supplier}
Total doses for each vaccine supplier (Pfizer/BioNTech, Moderna, Vaxzevria  \\
(AstraZeneca), Janssen, Pfizer Pediatrico).
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{"size":0,
  "aggs": {
    "supplier": {
      "terms": {
        "field": "supplier"
      },
      "aggs": {
        "total_doses" : { "sum" : {
          "field": "total_doses"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of doses for each NUTS1 zone}
Total number of doses administred in each NUTS1 zone (ITC= NorthWest, \\ 
ITH = NorthEast, ITI = Center, ITF = South, ITG = Isles)
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{"size":0,
  "aggs": {
    "by_NUTS1": {
      "terms": {
        "field": "NUTS1_code"
      },
      "aggs": {
        "total_doses" : { "sum" : {
          "field": "total_doses"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of people with previous infection by region}
Total number of people who were infected by Covid-19 within 3 to 6 months before the 
date of the vaccination for each region.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{
  "size":0,
  "aggs": {
    "Region": {
      "terms": {
        "field": "area"
      },
      "aggs": {
        "People with previous infection": {
          "sum": {
            "field": "previous_infection"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of doses for each age group}
Total number of doses administred to each age range ('05-11', '12-19', '20-29', '30-39',
'40-49', '50-59', '60-69', '70-79', '80-89', '90+').
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{"size":0,
  "aggs": {
    "by_age": {
      "terms": {
        "field": "age_range"
      },
      "aggs": {
        "total_doses" : { "sum" : { 
          "field": "total_doses"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\paragraph{Grouping by age range and region} \mbox{}

\vspace*{1em}

Total number of doses administred to each age range in each region.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{"size":0,
  "aggs": {
    "genres_and_products": {
      "multi_terms": {
        "terms": [{
          "field": "age_range" 
        }, {
          "field": "area"
        }], 
        "size": 1000
      },
      "aggs": {
        "total_doses" : { "sum" : { 
          "field": "total_doses"
          } 
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of average doses per region}
Average number of administred doses in each region.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{"size":0,
  "aggs": {
    "Region": {
      "terms": {
        "field": "area"
      },
      "aggs": {
        "avg_doses" : { "avg": {
          "field": "total_doses"
        } } 
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of doses for each age group and vaccine supplier}
Total number of doses by age group and vaccine supplier.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{
  "size": 0,
  "track_total_hits": true,
  "aggs": {
    "age_groups_types": {
      "composite": {
        "sources": [{
          "fascia_anagrafica": {
            "terms": { 
              "field": "age_range"
            }
          }
        }, {
          "supplier": {
            "terms": { 
              "field": "supplier"
            }
          }
        }], 
        "size": 10000
      },
      "aggs": {
        "total_vaccines": {
          "sum": {
            "field": "total_doses"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Number of booster doses for age range}
Total number of booster doses for each age range.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{
  "size": 0,
  "aggs": {
    "age_groups": {
      "terms": { 
        "field": "age_range" 
      },
      "aggs": {
        "boosters_per_group": {
          "sum": {
            "field": "booster_dose"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Top 10 dates with most vaccinations}
Top 10 dates having the highest number of administred doses.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET index-vaccines_administrations/_search
{
  "size": 0,
  "aggs": {
    "dates": {
      "terms": { 
        "field": "administration_date" 
      },
      "aggs": {
        "sum_vaccinations": {
          "sum": {
            "field": "total_doses"
          }
        },
        "dates_sort": {
          "bucket_sort": {
            "sort": [
              { "sum_vaccinations": { "order" : "desc" } }
            ],
            "size": 10
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Search by region name}
Returns information about vaccines in the specified region.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search
{
  "query": {
    "match": {
          "area_name": "Val d'aosta"
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Percentage of fully vaccinated people per region}
Returns the percentage of fully vaccinated people (i.e. having 1st and 2nd dose) 
for each region. \\
In order to obtain this resutl, we used additional data about the total population of 
each region contained into \emph{platea.csv}.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations,index-population/_search 
{
  "size": 0,
  "fields": [
    {
      "field": "@timestamp",
      "format": "date_time"
    },
    {
      "field": "administration_date",
      "format": "date_time"
    }
  ],
  "aggs": {
    "area_percentage": {
      "terms": {
        "field": "area",
        "size": 26
      },
      "aggs": {
        "hits": {
          "top_hits": {
            "size": 1,
            "_source": {
              "includes": "area_name"
            }
          }
        },
        "total_population": {
          "sum": {
            "field": "total_population"
          }
        },
        "second_dose": {
          "sum": {
            "field": "second_dose"
          }
        },
        "percentage_second_doses": {
          "bucket_script": {
            "buckets_path": {
              "total_pop": "total_population",
              "second_dose": "second_dose"
            },
            "script": "100 * params.second_dose / params.total_pop"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Percentage of healed people per region}
Returns the number of healed people over the total population for each region. \\
We used:
\begin{itemize}
  \item Data about the total population in each region from \emph{platea.csv};
  \item The number of healed people for each region that can be found in \\
    \emph{soggetti-guariti.csv}.
\end{itemize}
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-healed,index-population/_search 
{
  "size": 0,
  "fields": [
    {
      "field": "@timestamp",
      "format": "date_time"
    },
    {
      "field": "administration_date",
      "format": "date_time"
    }
  ],
  "aggs": {
    "area_percentage": {
      "terms": {
        "field": "area",
        "size": 26
      },
      "aggs": {
        "hits": {
          "top_hits": {
            "size": 1,
            "_source": {
              "includes": "area_name"
            }
          }
        },
        "total_population": {
          "sum": {
            "field": "total_population"
          }
        },
        "healed": {
          "sum": {
            "field": "total_healed"
          }
        },
        "percentage_healed": { 
          "bucket_script": {
            "buckets_path": {
              "total_pop": "total_population",
              "healed": "healed"
            },
            "script": "100 * params.healed / params.total_pop"
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Daily number of total cases, hospitalizations and positives}
Returns, the total number of cases, hopitalizations and positives for each day. \\
Given that this is not the total for a single day, but the overall total that is
increased day by day. \\
We used additional data from \emph{dpc-covid-19-ita-regioni.csv}.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-covid-information/_search 
{
"size": 0, 
  "aggs": {
    "date": {
      "terms": {
        "field": "data",
        "size": 365,
        "order": {
          "_key": "asc"
        }
      },
      "aggs": {
        "total_cases": {
          "sum": {
            "field": "total_cases"
          }
        },        
        "total_positives": {
          "sum": {
            "field": "total_positives"
          }
        },        
        "total_hospitalized": {
          "sum": {
            "field": "total_hospitalized"
          }
        }
      }
    }
  } 
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Ratio between positive and hospitalized people}
Returns the ratio between positive and hospitalized people for each region. It is calculated using
the data of \emph{dpc-covid19-ita-regioni.csv}.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
GET /index-vaccines_administrations/_search 
{
  "size": 0,
  "fields": [
    {
      "field": "data",
      "format": "date"
    }
  ],
  "sort": [
    {
      "data": {
        "order": "desc"
      }
    }
  ], 
  "aggs": {
    "ratio_positive_hospitalized": {
      "terms": {
        "field": "data",
        "size": 365
      },
      "aggs": {
        "region": {
          "terms": {
            "field": "ISTAT_region_code" 
          },
          "aggs": {
            "total_positives": {
              "sum": {
                "field": "total_positives"
              }
            },
            "total_hospitalized": {
              "sum": {
                "field": "total_hospitalized"
              }
            },
            "percentage_positive_hospitalized": {
              "bucket_script": {
                "buckets_path": {
                  "total_hospitalized": "total_hospitalized",
                  "total_positives": "total_positives"
                },
                "script": "100*params.total_hospitalized/params.total_positives"
              }
            }
          }
        }
      }
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\subsection{Commands}

\subsubsection{Add entries for a given day}
Adds a new document in the dataset.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
POST /index-vaccines_administrations/_doc/
 {    
    "area" : "FVG",
    "area_name" : "Friuli-Venezia Giulia",
    "second_dose" : 0,
    "previous_infection" : 1,
    "administration_date" : "2022-01-03",
    "NUTS1_code" : "ITH",
    "ISTAT_region_code" : 6,
    "male_gender" : 3,
    "first_dose" : 2,
    "age_range" : "30-39",
    "supplier" : "Moderna",
    "total_doses" : 3,
    "booster_dose" : 0,
    "NUTS2_code" : "ITH4",
    "female_gender" : 0,
    "total_doses" : 3
}
  \end{verbatim}
\end{tcolorbox}

\subsubsection{Remove entries from a given day}
Removes all documents from the index for the specified date.
\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
POST /index-vaccines_administrations/_delete_by_query
{
  "query": {
    "match": {
      "administration_date": "2022-01-03"
    }
  }
}
  \end{verbatim}
\end{tcolorbox}

\clearpage

\section{Data Visualization with Kibana}

We used the dashboard to give a visual representation of the most meaningful queries. \\
In order to use this dashboard, you need to create three indexes, one for each csv file (\emph{somministrazioni-vaccini-latest.csv, platea.csv, soggetti-guariti.csv}),
and name them respectively: "index-vaccines\_administrations", "index-population" and 
"index-healed". \\
Then, you need to add in the "index-patterns" section an aggregate index named "index"; 
it will create an overall "index-*" that combines all the indexes allowing you to see 
the desired visualizations in the dashboard. \todo{nuovo csv}

\subsection{Screenshots}
\subsubsection{Control panel}
It allows to filter the results of the other elements of the dashboard based on region,
vaccine supplier and age range.
\begin{figure}[ht]
  \centering
  \includegraphics[width=.9\linewidth]{img (2).png}
\end{figure}

\subsubsection{Vaccinations for each region}
It allows to represent a dynamic map of Italy divided in regions. By default it shows the
number of administred first doses in each region. \\ 
By hovering over a region, it shows a description of the number of vaccinations for each
type (first, second, booster doses and so on) administered by that region.

\begin{figure}[H]
  \centering
  \includegraphics[width=.8\linewidth]{img (4).png}
  \caption*{Map of Italy}
\end{figure}

\begin{figure}[H]
  \centering
  \includegraphics[width=.8\linewidth]{img (5).png}
  \caption*{Result of hovering}
\end{figure}

\subsubsection{Pie charts}
The two pie charts represent the percentage of doses for each vaccine supploer and for 
each NUTS1 over the total administred vaccines.
\begin{figure}[H]
  \centering
  \includegraphics[width=1\linewidth]{img (7).png}
  \caption*{Percentage of doses for each vaccine brand  (left) and for each NUTS1 (right)}
\end{figure}

\subsubsection{Metric Visualization}
It represents the percentage of people with at least one, two or three doses together 
with the number of people who healed from Covid-19 in the selected region (or the whole 
Italy if none is selected). \\
These numbers are obtained by integrating two different datasets:
\begin{itemize}
  \item The percentages of vaccinated people are calculated using data about the total
    population in each region from \emph{platea.csv};
  \item The number of healed people for each region can be found in 
    \emph{soggetti-guariti.csv}.
\end{itemize}
\begin{figure}[H]
  \centering
  \includegraphics[width=.8\linewidth]{img (8).png}
  \caption*{Metric visualization}
\end{figure}

\subsubsection{Number of vaccines by genre}
Represents a comparison between the total number of vaccines done by males and females,
in each week from the starting date selected. By hovering with the mouse, a more 
detailed percentage is shown.
\begin{figure}[H]
  \centering
  \includegraphics[width=.8\linewidth]{img (9).png}
  \caption*{Number of vaccines by genre}
\end{figure}

\subsubsection{Average number of vaccines by region}
Represents the average number of vaccines administred in each region.
\begin{figure}[H]
  \centering
  \includegraphics[width=.8\linewidth]{img (10).png}
  \caption*{Average number of vaccines by region}
\end{figure}

\subsubsection{Number of 1st, 2nd and booster doses per week}
It shows a graph that, for each week from the starting date selected, represents the 
trend of the total doses administered by type (1st, 2nd or booster doses).
\begin{figure}[H]
  \centering
  \includegraphics[width=.9\linewidth]{img (11).png}
  \caption*{Number of 1st, 2nd and booster doses}
\end{figure}

\subsubsection{Total number of vaccines by date}
It shows the total number of administred doses in each day.
\begin{figure}[H]
  \centering
  \includegraphics[width=1\linewidth]{img (12).png}
  \caption*{Total number of vaccines by date}
\end{figure}

\subsubsection{Number of vaccines per gender in each region}
It shows the top 10 regions for number of administred doses divided by gender.
\begin{figure}[H]
  \centering
  \includegraphics[width=.9\linewidth]{img (14).png}
  \caption*{Number of vaccines per gender in each region}
\end{figure}

\subsubsection{Number of vaccinations by age range}
It shows the number of administred doses for each age range, sorted by number of doses.
\begin{figure}[H]
  \centering
  \includegraphics[width=.85\linewidth]{img (15).png}
  \caption*{Number of vaccinations by age range}
\end{figure}

\subsubsection{Number of people with previous infection in each region}
It shows, for each region, the number of people who were infected by Covid-19 before 
doing the vaccination.
\begin{figure}[H]
  \centering
  \includegraphics[width=.9\linewidth]{img (16).png}
  \caption*{Number of people with previous infection in each region}
\end{figure}

\clearpage

%OPTIONAL POINT N°2
\section{Other features in HBase} 

We deciced to use \emph{HBase} as an alternative NoSQL DBMS in order to implement some 
additional features. \\
\emph{HBase} is a column-oriented DBMS usually utilized in the context of the 
\emph{Apache Hadoop} framework, it can be run locally using \emph{Apache Zookeeper} or 
by installing \emph{Hadoop} and running \emph{HBase} on top of \emph{HDFS}.

\subsection{Input Data Preparation}

In order to import data into \emph{HBase}, the first step is to eliminate the labels 
from the csv file containing raw data. \\
In our case the file has been renamed as \emph{vaccines\_administrations\_latest.csv} 
and a \\ unique ID generated using \emph{Python} \texttt{uuid.uuid4()} function 
(from the \texttt{uuid} library) has been added as the first item for each row since
HBase expects a row key in that particular position. \\ 
The unique ID was generate in this way since an incremental sequential number as a 
row key is not recommended according to the \emph{HBase} documentation. 

\noindent
Once we have the data in CSV format, we have to store it in a path from where 
\emph{HBase} can access it. \\
If we want to load the file using Hadoop, we will have to copy the file to the 
\emph{HDFS} location, this can be done using the command:
\begin{footnotesize}
  \begin{itemize}
    \item[] \texttt{hadoop fs -copyFromLocal <LOCAL\_PATH>  <HDFS\_PATH>} 
  \end{itemize}
\end{footnotesize}

\subsection{Storing data into HBase}

\begin{footnotesize}
  \begin{itemize}
    \item[] \texttt{create 'vaccines\_administrations', \{NAME => '\_date'\}, \\
      \{NAME => '\_type'\}, \{NAME => 'region'\}, \\
      \{NAME => 'stats'\}, \{NAME => 'doses'\}, \{NAME => 'nuts'\}} 
  \end{itemize}
\end{footnotesize}
This command will create an \emph{HBase} table in order to store the data. \\
Notice that we are creating five column families for some of the columns of the CSV file,
this is done for accessing and querying the data in a more easier and flexible way using
\emph{Apache Drill}. 

\vfill % Aesthetic purpose

\begin{footnotesize}
  \begin{itemize}
    \item[] \texttt{./hbase org.apache.hadoop.hbase.mapreduce.ImportTsv \\
      -Dimporttsv.separator=',' \\
      -Dimporttsv.columns=HBASE\_ROW\_KEY,\_date:administration\_date, \\
        \_type:supplier,region:area,stats:age\_range,stats:male\_gender, \\
        stats:female\_gender,doses:first\_dose,doses:second\_dose, \\
        doses:previous\_infection,doses:booster\_dose,nuts:NUTS1\_code, \\
        nuts:NUTS2\_code,region:ISTAT\_region\_code,region:area\_name \\
      vaccines\_administrations \\
      <PATH>} 
  \end{itemize}
\end{footnotesize}
Once we submit this command a \emph{MapReduce} that will import the CSV file into the 
HBase table that we created will start. \\
Each column of the CSV file is mapped into the respective column family.  \\
\texttt{<PATH>} needs be changed to the HDFS path if we are using \emph{Hadoop} or to 
the local path of the CSV file if we are using \emph{Zookeeper}. \\
The output should resemble the following: 

\begin{figure}[ht]
  \centering
  \includegraphics[width=\linewidth]{hbase_import.png}
\end{figure}

\subsection{Querying HBase}

For querying \emph{HBase} we decided to use \emph{Apache Drill}, this means that our
queries will be written in SQL and can benefit from all the extensions that the 
framework provides. \\
To be able to query an \emph{HBase} database, after running \emph{Apache Drill} in 
embedded mode, we will have to go to the storage section and enable \emph{HBase}.  

\noindent
The translation of some Elasticsearch queries with sample screenshots of possible results
will be provided here, a more complete selection of queries will be provided separately.

\subsubsection{Number of daily vaccines for each dose}

\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
SELECT CONVERT_FROM(vaccines_administrations._date.administration_date, 'UTF8') 
        AS date_time,
  SUM(CAST(vaccines_administrations.doses.first_dose AS INT)) 
          AS number_of_daily_vaccines_first_dose,
  SUM(CAST(vaccines_administrations.doses.second_dose AS INT)) 
          AS number_of_daily_vaccines_second_dose,
  SUM(CAST(vaccines_administrations.doses.booster_dose AS INT)) 
          AS number_of_daily_vaccines_booster_dose
FROM vaccines_administrations
GROUP BY date_time
  \end{verbatim}
\end{tcolorbox}

\noindent
Possible result:
\begin{figure}[ht]
  \centering
  \includegraphics[width=\linewidth]{hbase_query_1.png}
\end{figure}

\subsubsection{Number of doses for each vaccine supplier}

\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
SELECT CONVERT_FROM(vaccines_administrations._type.supplier, 'UTF8') 
        AS supplier,
  SUM(CAST(vaccines_administrations.doses.first_dose AS INT)   + 
      CAST(vaccines_administrations.doses.second_dose AS INT)  + 
      CAST(vaccines_administrations.doses.booster_dose AS INT) +
      CAST(vaccines_administrations.doses.previous_infection AS INT)) 
          AS total_doses
FROM vaccines_administrations
GROUP BY supplier
  \end{verbatim}
\end{tcolorbox}

\clearpage % Aesthetic purpose

\noindent
Possible result:
\begin{figure}[ht]
  \centering
  \includegraphics[width=\linewidth]{hbase_query_2.png}
\end{figure}

\subsubsection{Top 10 dates with most vaccinations}

\begin{tcolorbox}[fontupper=\scriptsize]
  \begin{verbatim}
SELECT CONVERT_FROM(vaccines_administrations._date.administration_date, 'UTF8') 
        AS administration_date,
  SUM(CAST(vaccines_administrations.doses.first_dose AS INT)   + 
      CAST(vaccines_administrations.doses.second_dose AS INT)  + 
      CAST(vaccines_administrations.doses.booster_dose AS INT) +
      CAST(vaccines_administrations.doses.previous_infection AS INT)) 
          AS total_vaccinations
FROM vaccines_administrations
GROUP BY administration_date
ORDER BY total_vaccinations ASC
LIMIT 10;
  \end{verbatim}
\end{tcolorbox}

\noindent
Possible result:
\begin{figure}[ht]
  \centering
  \includegraphics[width=\linewidth]{hbase_query_3.png}
\end{figure}

\clearpage

% REFERENCES AND SOURCES
\section{References and sources}

In order to develop this project, the following tools were used:

\begin{itemize}
    \item Elasticsearch and Kibana in order to store, query and visualize data;
    \item HBase, HDFS, Hadoop, Apache Drill and Zookeeper as an alternative NoSQL 
      framework for some features;
    \item Python as a mean to easily modify and prepare files for import;
    \item \LaTeX~to write the report;
    \item Github as a versioning and collaboration mean;
    \item \url{https://github.com/italia/covid19-opendata-vaccini} \\
        as a source of updated and real data about vaccinations in Italy.
    \item \url{https://github.com/pcm-dpc/COVID-19} \\
        as an alternative source for additional data about Covid-19 in Italy.
\end{itemize}

\clearpage

\end{document}
